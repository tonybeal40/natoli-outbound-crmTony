<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Natoli Outbound Activity - Tony Beal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#07070a;
      --bg2:#0e0f14;
      --card:#0f1118;
      --card2:#121521;
      --ink:#f5f7ff;
      --muted:#b1b6c8;
      --muted2:#8b91a8;
      --line:#222638;

      --accent:#e11d48;
      --accent2:#ff3b6a;
      --accentSoft: rgba(225,29,72,.14);

      --good:#22c55e;
      --warn:#fbbf24;

      --radius:18px;
      --pill:999px;
      --shadow: 0 18px 45px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, rgba(225,29,72,.12) 0, transparent 42%),
        radial-gradient(circle at top, #1a1c24 0, #07070a 58%, #030309 100%);
      color:var(--ink);
    }

    a{ color: var(--accent2); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .shell{
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.8rem 1rem 3rem;
    }

    .top-bar{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-end;
      justify-content:space-between;
      gap:1.2rem;
      margin-bottom: 1.2rem;
    }

    .app-title{
      margin:0 0 .25rem;
      font-size: 1.8rem;
      letter-spacing:.08em;
      text-transform: uppercase;
    }
    .app-subtitle{
      margin:0;
      font-size:.95rem;
      color:var(--muted);
      max-width: 760px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:.55rem;
      padding:.38rem .95rem;
      border-radius:var(--pill);
      background: var(--accentSoft);
      border: 1px solid rgba(255,59,106,.45);
      font-size:.78rem;
      color: #ffd0dc;
      text-transform: uppercase;
      letter-spacing:.12em;
      user-select:none;
      white-space:nowrap;
    }

    .kpi-strip{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:.9rem;
      margin: 1.0rem 0 1.2rem;
    }
    @media (max-width: 1100px){
      .kpi-strip{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 650px){
      .kpi-strip{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .kpi{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: .9rem 1rem;
      box-shadow: var(--shadow);
    }
    .kpi-label{
      font-size:.72rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted2);
      margin-bottom:.35rem;
    }
    .kpi-value{
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing:.02em;
    }
    .kpi-sub{
      margin-top:.35rem;
      font-size:.78rem;
      color:var(--muted);
      display:flex;
      gap:.4rem;
      align-items:center;
      flex-wrap:wrap;
    }
    .dot{
      width:8px; height:8px; border-radius:99px;
      background: rgba(255,255,255,.25);
      display:inline-block;
    }
    .dot.red{ background: var(--accent2); }
    .dot.green{ background: var(--good); }
    .dot.amber{ background: var(--warn); }

    .grid{
      display:grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 2fr);
      gap: 1.6rem;
      align-items: start;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background:
        radial-gradient(circle at top left, rgba(255,59,106,.09) 0, transparent 45%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 1.25rem 1.25rem 1.35rem;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:.9rem;
      margin-bottom: .95rem;
    }

    .card-title{
      margin:0;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing:.09em;
      text-transform: uppercase;
    }

    .card-sub{
      margin:.25rem 0 0;
      font-size:.86rem;
      color: var(--muted2);
      line-height: 1.35;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      padding:.28rem .75rem;
      border-radius: var(--pill);
      border:1px solid rgba(255,59,106,.45);
      background: rgba(225,29,72,.10);
      color:#ffd0dc;
      font-size:.74rem;
      text-transform: uppercase;
      letter-spacing:.12em;
      white-space:nowrap;
      user-select:none;
    }

    form{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: .9rem 1.1rem;
      margin-top: .75rem;
    }
    @media (max-width: 700px){
      form{ grid-template-columns: 1fr; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:.32rem;
    }
    label{
      font-size:.74rem;
      text-transform: uppercase;
      letter-spacing:.12em;
      color: var(--muted);
    }
    input, select, textarea{
      padding:.58rem .72rem;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--ink);
      font-size:.92rem;
      outline:none;
    }
    textarea{
      min-height: 84px;
      resize: vertical;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(255,59,106,.75);
      box-shadow: 0 0 0 1px rgba(255,59,106,.35);
    }
    .full{ grid-column: 1 / -1; }

    .btn-row{
      display:flex;
      gap:.7rem;
      flex-wrap:wrap;
      margin-top:.25rem;
    }

    button{
      border:none;
      cursor:pointer;
      border-radius: var(--pill);
      padding:.58rem 1.1rem;
      font-size:.92rem;
      font-weight: 650;
      letter-spacing:.01em;
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      user-select:none;
    }
    .btn-primary{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#0a0a0d;
    }
    .btn-ghost{
      background: transparent;
      color: var(--muted);
      border:1px solid var(--line);
    }
    .btn-danger{
      background: rgba(225,29,72,.12);
      color:#ffd0dc;
      border:1px solid rgba(255,59,106,.45);
    }
    .btn-small{
      padding:.28rem .72rem;
      font-size:.76rem;
      font-weight: 650;
      border-radius: 999px;
      letter-spacing:.02em;
    }

    .hint{
      margin:.65rem 0 0;
      font-size:.82rem;
      color: var(--muted2);
      line-height: 1.35;
    }

    .file-row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:.7rem;
      margin-top:.25rem;
    }
    input[type="file"]{
      padding:.2rem;
      background:transparent;
      border:none;
    }

    .status-text{
      margin:.5rem 0 0;
      font-size:.82rem;
      color: var(--muted);
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .controls{
      display:grid;
      grid-template-columns: 1.4fr .8fr .8fr 1fr;
      gap:.75rem;
      margin-top:.6rem;
      align-items:end;
    }
    @media (max-width: 900px){
      .controls{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 520px){
      .controls{ grid-template-columns: 1fr; }
    }

    .table-wrap{
      margin-top:.85rem;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.82rem;
    }
    thead{
      background: rgba(0,0,0,.28);
    }
    th, td{
      padding:.55rem .7rem;
      text-align:left;
      border-bottom: 1px solid rgba(34,38,56,.85);
      white-space:nowrap;
      vertical-align:top;
    }
    th{
      text-transform: uppercase;
      letter-spacing:.12em;
      font-size:.7rem;
      color: var(--muted2);
    }
    tbody tr:nth-child(even){
      background: rgba(255,255,255,.02);
    }

    .pill-sent{
      display:inline-flex;
      align-items:center;
      padding:.15rem .6rem;
      border-radius:var(--pill);
      font-size:.7rem;
      background: rgba(34,197,94,.12);
      color: var(--good);
      border: 1px solid rgba(34,197,94,.55);
      user-select:none;
    }
    .pill-not{
      display:inline-flex;
      align-items:center;
      padding:.15rem .6rem;
      border-radius:var(--pill);
      font-size:.7rem;
      background: rgba(251,191,36,.12);
      color: var(--warn);
      border: 1px solid rgba(251,191,36,.55);
      user-select:none;
    }

    .pill-stage{
      display:inline-flex;
      align-items:center;
      padding:.15rem .6rem;
      border-radius:var(--pill);
      font-size:.7rem;
      background: rgba(255,59,106,.10);
      color:#ffd0dc;
      border: 1px solid rgba(255,59,106,.35);
      user-select:none;
    }

    .pill-risk{
      display:inline-flex;
      align-items:center;
      padding:.15rem .6rem;
      border-radius:var(--pill);
      font-size:.7rem;
      background: rgba(251,191,36,.12);
      color: var(--warn);
      border: 1px solid rgba(251,191,36,.55);
      user-select:none;
    }

    .muted{ color: var(--muted2); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .progress-wrap{
      margin-top:.7rem;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: .85rem 1rem;
      background: rgba(0,0,0,.18);
    }
    .progress-row{
      display:flex;
      justify-content:space-between;
      gap:1rem;
      flex-wrap:wrap;
      align-items:baseline;
      margin-bottom:.55rem;
    }
    .progress-title{
      font-weight: 750;
      letter-spacing:.02em;
    }
    .progress-sub{
      color: var(--muted2);
      font-size:.82rem;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(34,38,56,.9);
      overflow:hidden;
    }
    .bar > span{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 999px;
    }

    .chart-card{
      margin-top: .95rem;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: .9rem 1rem;
      background: rgba(0,0,0,.18);
    }
    .chart-header{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:1rem;
      flex-wrap:wrap;
      margin-bottom:.55rem;
    }
    canvas{
      width: 100%;
      height: 210px;
      display:block;
      border-radius: 12px;
      background: rgba(255,255,255,.02);
      border: 1px solid rgba(34,38,56,.7);
    }

    .rollup-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:.75rem;
      margin-top:.65rem;
      align-items:end;
    }
    @media (max-width: 650px){
      .rollup-grid{ grid-template-columns: 1fr; }
    }

    .click-row{ cursor:pointer; }
    .click-row:hover{ background: rgba(255,59,106,.06); }

    .hidden{ display:none; }

    .row-actions{
      display:flex;
      gap:.4rem;
      flex-wrap:wrap;
    }

    .mini-note{
      white-space: normal;
      max-width: 260px;
      line-height: 1.2;
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="top-bar">
      <div>
        <h1 class="app-title">Natoli Outbound Activity</h1>
        <p class="app-subtitle">
          Contact capture, send tracking, weekly output, and account rollups for outbound control
        </p>
      </div>
      <span class="pill">Outbound CRM Lite</span>
    </div>

    <section class="kpi-strip" aria-label="KPIs">
      <div class="kpi">
        <div class="kpi-label">Total contacts</div>
        <div class="kpi-value" id="kpiTotal">0</div>
        <div class="kpi-sub"><span class="dot red"></span><span>Stored locally plus Google Sheets</span></div>
      </div>

      <div class="kpi">
        <div class="kpi-label">Sent total</div>
        <div class="kpi-value" id="kpiSent">0</div>
        <div class="kpi-sub" id="kpiProgressTag"><span class="dot green"></span><span>0 of 0 completed</span></div>
      </div>

      <div class="kpi">
        <div class="kpi-label">Added today</div>
        <div class="kpi-value" id="kpiAddedToday">0</div>
        <div class="kpi-sub"><span class="dot red"></span><span>New records</span></div>
      </div>

      <div class="kpi">
        <div class="kpi-label">Added this week</div>
        <div class="kpi-value" id="kpiAddedWeek">0</div>
        <div class="kpi-sub"><span class="dot red"></span><span>Monday to Sunday</span></div>
      </div>

      <div class="kpi">
        <div class="kpi-label">Sent today</div>
        <div class="kpi-value" id="kpiSentToday">0</div>
        <div class="kpi-sub"><span class="dot green"></span><span>Marked sent</span></div>
      </div>

      <div class="kpi">
        <div class="kpi-label">Sent this week</div>
        <div class="kpi-value" id="kpiSentWeek">0</div>
        <div class="kpi-sub"><span class="dot green"></span><span>Weekly output</span></div>
      </div>
    </section>

    <div class="grid">
      <!-- Left -->
      <section class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Add contact</h2>
            <p class="card-sub">Clean capture, stage, notes, next step, and Sheets sync</p>
          </div>
          <span class="badge">Clean data</span>
        </div>

        <form id="contactForm">
          <div class="field">
            <label for="firstName">First Name</label>
            <input id="firstName" required />
          </div>
          <div class="field">
            <label for="lastName">Last Name</label>
            <input id="lastName" />
          </div>

          <div class="field">
            <label for="title">Title</label>
            <input id="title" />
          </div>
          <div class="field">
            <label for="company">Company Name</label>
            <input id="company" />
          </div>

          <div class="field">
            <label for="email">Email</label>
            <input id="email" type="email" />
          </div>
          <div class="field">
            <label for="phone">Phone</label>
            <input id="phone" />
          </div>

          <div class="field">
            <label for="industry">Industry</label>
            <input id="industry" />
          </div>
          <div class="field">
            <label for="linkedin">Person Linkedin Url</label>
            <input id="linkedin" placeholder="https://linkedin.com/in/..." />
          </div>

          <div class="field">
            <label for="stage">Stage</label>
            <select id="stage">
              <option value="New">New</option>
              <option value="Researched">Researched</option>
              <option value="Contacted">Contacted</option>
              <option value="Follow-up">Follow-up</option>
              <option value="Meeting">Meeting</option>
              <option value="Closed/Won">Closed/Won</option>
              <option value="Closed/Lost">Closed/Lost</option>
            </select>
          </div>

          <div class="field">
            <label for="nextStep">Next Step</label>
            <input id="nextStep" placeholder="Example: Follow up Friday" />
          </div>

          <div class="field full">
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="Pain point, angle, context"></textarea>
          </div>

          <div class="full btn-row">
            <button type="submit" class="btn-primary" id="submitBtn">Add contact to list</button>
            <button type="button" id="clearAll" class="btn-danger">Clear all contacts</button>
          </div>

          <div class="full">
            <p class="hint">
              Dedupe guard: email match updates the record instead of duplicating it
            </p>
          </div>
        </form>

        <div class="card-header" style="margin-top:1.2rem;">
          <div>
            <h2 class="card-title">Import / Export</h2>
            <p class="card-sub">
              CSV headers stay compatible: First Name, Last Name, Title, Company Name, Email, Phone, Industry, Person Linkedin Url
            </p>
          </div>
        </div>

        <div class="file-row">
          <input type="file" id="csvFile" accept=".csv" />
          <button type="button" id="importCsv" class="btn-ghost">Import CSV</button>
        </div>

        <div class="file-row">
          <label class="muted" style="font-size:.78rem; text-transform:uppercase; letter-spacing:.12em;">Export mode</label>
          <select id="exportMode">
            <option value="all">All</option>
            <option value="sent">Sent only</option>
            <option value="notSent">Not sent only</option>
            <option value="thisWeek">This week only</option>
          </select>
          <button type="button" id="exportCsv" class="btn-ghost">Export CSV</button>
        </div>

        <div class="card-header" style="margin-top:1.2rem;">
          <div>
            <h2 class="card-title">Backup / Restore</h2>
            <p class="card-sub">Guaranteed restore point if storage ever clears</p>
          </div>
        </div>

        <div class="file-row">
          <button type="button" id="backupJson" class="btn-ghost">Download JSON backup</button>
          <input type="file" id="jsonFile" accept=".json" />
          <button type="button" id="restoreJson" class="btn-ghost">Restore JSON</button>
        </div>

        <p class="status-text" id="importStatus"></p>
      </section>

      <!-- Right -->
      <section class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Outbound command view</h2>
            <p class="card-sub">Weekly output, visibility, and account control</p>
          </div>
          <span class="badge">Revenue cadence</span>
        </div>

        <div class="progress-wrap">
          <div class="progress-row">
            <div>
              <div class="progress-title">Weekly send target</div>
              <div class="progress-sub" id="weekRangeLabel">This week</div>
            </div>
            <div style="display:flex; gap:.6rem; align-items:end; flex-wrap:wrap;">
              <div class="field" style="min-width:180px;">
                <label for="weeklyTarget">Target</label>
                <input id="weeklyTarget" type="number" min="0" step="1" />
              </div>
              <button type="button" id="saveTarget" class="btn-primary btn-small">Save</button>
            </div>
          </div>
          <div class="bar" aria-label="Weekly progress">
            <span id="weekProgressBar"></span>
          </div>
          <div class="hint" id="weekProgressText" style="margin-top:.55rem;">0 sent this week</div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div style="font-weight:800; letter-spacing:.02em;">Weekly activity</div>
              <div class="muted" style="font-size:.82rem;">Added vs Sent for the last 8 weeks</div>
            </div>
            <div class="muted" style="font-size:.82rem;">
              Legend: <span class="dot red"></span> Added <span style="margin-left:.5rem;"></span><span class="dot green"></span> Sent
            </div>
          </div>
          <canvas id="weeklyChart" width="900" height="260"></canvas>
          <div class="hint">Updates automatically using createdAt and sentDate</div>
        </div>

        <div class="card-header" style="margin-top:1.1rem;">
          <div>
            <h2 class="card-title">Company rollup</h2>
            <p class="card-sub">Top accounts by volume, send rate, and last activity. Click a row to filter your list</p>
          </div>
          <span class="badge" id="riskBadge">0 at risk</span>
        </div>

        <div class="rollup-grid">
          <div class="field">
            <label for="companySearch">Company search</label>
            <input id="companySearch" placeholder="Filter rollup by company name" />
          </div>
          <div class="field">
            <label for="rollupLimit">Show</label>
            <select id="rollupLimit">
              <option value="10">Top 10</option>
              <option value="15" selected>Top 15</option>
              <option value="25">Top 25</option>
              <option value="50">Top 50</option>
            </select>
          </div>
        </div>

        <div class="table-wrap" style="margin-top:.75rem;">
          <table>
            <thead>
              <tr>
                <th>Company</th>
                <th>Contacts</th>
                <th>Sent</th>
                <th>Not sent</th>
                <th>Send rate</th>
                <th>Last activity</th>
                <th>Next step cue</th>
                <th>Flag</th>
              </tr>
            </thead>
            <tbody id="companyBody"></tbody>
          </table>
        </div>
        <div class="hint">At risk rule: 3+ contacts and 0 sent</div>

        <div class="card-header" style="margin-top:1.1rem;">
          <div>
            <h2 class="card-title">List controls</h2>
            <p class="card-sub">Search, filter, and sort without scrolling forever</p>
          </div>
        </div>

        <div class="controls">
          <div class="field">
            <label for="search">Search</label>
            <input id="search" placeholder="Name, company, email" />
          </div>

          <div class="field">
            <label for="filterSent">Filter</label>
            <select id="filterSent">
              <option value="all">All</option>
              <option value="sent">Sent</option>
              <option value="notSent">Not sent</option>
            </select>
          </div>

          <div class="field">
            <label for="sortBy">Sort</label>
            <select id="sortBy">
              <option value="newest">Newest added</option>
              <option value="oldest">Oldest added</option>
              <option value="companyAZ">Company A to Z</option>
              <option value="companyZA">Company Z to A</option>
              <option value="sentNewest">Sent newest</option>
              <option value="sentOldest">Sent oldest</option>
            </select>
          </div>

          <div class="field">
            <label for="toggleList">List</label>
            <button type="button" id="toggleList" class="btn-ghost">Show / hide contact list</button>
          </div>
        </div>

        <div id="listSection" class="hidden">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>First</th>
                  <th>Last</th>
                  <th>Title</th>
                  <th>Company</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Industry</th>
                  <th>Linkedin</th>
                  <th>Stage</th>
                  <th>Status</th>
                  <th>Next</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="contactsBody"></tbody>
            </table>
          </div>
          <p class="hint">
            Storage: <span class="mono">localStorage</span> plus exports. Use JSON backup for guaranteed restore
          </p>
        </div>

        <p class="status-text" id="syncStatus"></p>
      </section>
    </div>
  </div>

  <script>
    // =============================
    // STEP 1: GOOGLE APPS SCRIPT URL
    // =============================
    // IMPORTANT: This must be inside the script, near the top
    const API_URL = "https://script.google.com/macros/s/AKfycbwOMaVCO6o0_fYOcUATAcLJOC7S0VEobA-PBmX-FdBf8BZQ_OTiDAG96OVXzzOUbaAi/exec";

    // Turn off if you want local-only temporarily
    const SHEETS_SYNC_ENABLED = true;

    // ====== SHARED STORAGE KEYS (use these across ALL pages) ======
    const STORAGE_KEY = "NATOLI_OUTBOUND_CONTACTS_V2";
    const TARGET_KEY  = "NATOLI_OUTBOUND_WEEKLY_TARGET_V1";

    const BC = ("BroadcastChannel" in window) ? new BroadcastChannel("natoli_outbound_updates") : null;

    let contacts = [];
    let editId = null;

    function broadcastUpdate(){
      try{
        if (BC) BC.postMessage({ type:"contacts_updated", at: new Date().toISOString() });
      }catch(e){}
      try{
        localStorage.setItem("NATOLI_OUTBOUND_LAST_UPDATE", String(Date.now()));
      }catch(e){}
    }

    function uid() {
      return "c_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function safeLower(s) {
      return (s || "").trim().toLowerCase();
    }

    function nowIso() {
      return new Date().toISOString();
    }

    function parseIso(iso) {
      const d = new Date(iso);
      return isNaN(d.getTime()) ? null : d;
    }

    function startOfDay(d) {
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x;
    }

    function isSameDay(a, b) {
      return startOfDay(a).getTime() === startOfDay(b).getTime();
    }

    function startOfWeek(d) {
      const x = new Date(d);
      const day = (x.getDay() + 6) % 7; // Monday = 0
      x.setDate(x.getDate() - day);
      x.setHours(0,0,0,0);
      return x;
    }

    function endOfWeek(d) {
      const s = startOfWeek(d);
      const e = new Date(s);
      e.setDate(e.getDate() + 6);
      e.setHours(23,59,59,999);
      return e;
    }

    function inRange(date, start, end) {
      const t = date.getTime();
      return t >= start.getTime() && t <= end.getTime();
    }

    function formatDateShort(d) {
      return d.toLocaleDateString(undefined, { month: "short", day: "2-digit" });
    }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"quot;")
        .replaceAll("'","&#039;");
    }

    function normalizeContact(c) {
      const out = Object.assign({}, c);

      out.id = out.id || uid();
      out.firstName = (out.firstName || out["First Name"] || "").toString();
      out.lastName = (out.lastName || out["Last Name"] || "").toString();
      out.title = (out.title || out["Title"] || "").toString();
      out.company = (out.company || out["Company Name"] || out.companyName || "").toString();
      out.email = (out.email || out["Email"] || "").toString();
      out.phone = (out.phone || out["Phone"] || "").toString();
      out.industry = (out.industry || out["Industry"] || "").toString();
      out.linkedin = (out.linkedin || out["Person Linkedin Url"] || out.personLinkedinUrl || "").toString();

      out.createdAt = out.createdAt || out["Created At"] || nowIso();
      out.updatedAt = out.updatedAt || nowIso();

      out.sent = typeof out.sent === "boolean" ? out.sent : (safeLower(out["Sent"]) === "yes");
      out.sentDate = out.sentDate || out["Sent Date"] || null;

      out.stage = out.stage || out["Stage"] || "New";
      out.notes = out.notes || out["Notes"] || "";
      out.nextStep = out.nextStep || out["Next Step"] || "";

      return out;
    }

    // =============================
    // GOOGLE SHEETS SYNC LAYER
    // =============================
    const syncEl = document.getElementById("syncStatus");

    function setSyncStatus(msg){
      if (!syncEl) return;
      syncEl.textContent = msg || "";
    }

    async function postJson(url, payload){
      // Apps Script web apps sometimes dislike standard CORS headers.
      // This tries JSON first, then falls back to form encoding.
      try{
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        let data = null;
        try{ data = JSON.parse(text); }catch(e){}
        return { ok: res.ok, status: res.status, text, data };
      }catch(err){
        // fallback: form
        const form = new URLSearchParams();
        form.set("payload", JSON.stringify(payload));
        const res = await fetch(url, { method:"POST", body: form });
        const text = await res.text();
        let data = null;
        try{ data = JSON.parse(text); }catch(e){}
        return { ok: res.ok, status: res.status, text, data };
      }
    }

    async function sheetsUpsert(contact){
      if (!SHEETS_SYNC_ENABLED) return;
      if (!API_URL || API_URL === "...") {
        setSyncStatus("Sheets sync disabled. API_URL is not set");
        return;
      }

      const payload = {
        action: "upsert",
        source: "netlify",
        contact: contact
      };

      setSyncStatus("Syncing to Google Sheets...");
      const r = await postJson(API_URL, payload);

      if (r.ok) {
        setSyncStatus("Synced to Google Sheets");
      } else {
        setSyncStatus("Sheets sync failed. Check Apps Script deployment and permissions");
      }
    }

    async function sheetsDelete(contact){
      if (!SHEETS_SYNC_ENABLED) return;
      if (!API_URL || API_URL === "...") return;

      const payload = {
        action: "delete",
        source: "netlify",
        id: contact?.id || "",
        email: contact?.email || "",
        company: contact?.company || ""
      };

      setSyncStatus("Syncing delete to Google Sheets...");
      const r = await postJson(API_URL, payload);

      if (r.ok) setSyncStatus("Delete synced to Google Sheets");
      else setSyncStatus("Delete sync failed. Check Apps Script handler");
    }

    async function sheetsClearAll(){
      if (!SHEETS_SYNC_ENABLED) return;
      if (!API_URL || API_URL === "...") return;

      const payload = { action: "clear", source: "netlify" };

      setSyncStatus("Syncing clear to Google Sheets...");
      const r = await postJson(API_URL, payload);

      if (r.ok) setSyncStatus("Clear synced to Google Sheets");
      else setSyncStatus("Clear sync failed. Check Apps Script handler");
    }

    // =============================
    // TARGET
    // =============================
    function loadTarget() {
      const raw = localStorage.getItem(TARGET_KEY);
      const n = raw ? Number(raw) : 0;
      document.getElementById("weeklyTarget").value = (Number.isFinite(n) && n >= 0) ? n : 0;
    }

    function saveTarget() {
      const val = Number(document.getElementById("weeklyTarget").value || 0);
      const clean = Number.isFinite(val) && val >= 0 ? Math.floor(val) : 0;
      localStorage.setItem(TARGET_KEY, String(clean));
      broadcastUpdate();
      renderAll();
    }

    // =============================
    // STORAGE
    // =============================
    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        contacts = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(contacts)) contacts = [];
      } catch (e) {
        contacts = [];
      }

      contacts = contacts.map(c => normalizeContact(c));
      saveToStorage(false);
      loadTarget();
      renderAll();
    }

    function saveToStorage(renderAfter = true) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(contacts));
      broadcastUpdate();
      if (renderAfter) renderAll();
    }

    // =============================
    // KPIs + RENDER
    // =============================
    function computeKPIs() {
      const total = contacts.length;
      const sentTotal = contacts.filter(c => c.sent).length;

      const today = new Date();
      const weekStart = startOfWeek(today);
      const weekEnd = endOfWeek(today);

      const addedToday = contacts.filter(c => {
        const d = parseIso(c.createdAt);
        return d ? isSameDay(d, today) : false;
      }).length;

      const addedWeek = contacts.filter(c => {
        const d = parseIso(c.createdAt);
        return d ? inRange(d, weekStart, weekEnd) : false;
      }).length;

      const sentToday = contacts.filter(c => {
        const d = parseIso(c.sentDate);
        return d ? isSameDay(d, today) : false;
      }).length;

      const sentWeek = contacts.filter(c => {
        const d = parseIso(c.sentDate);
        return d ? inRange(d, weekStart, weekEnd) : false;
      }).length;

      return { total, sentTotal, addedToday, addedWeek, sentToday, sentWeek, weekStart, weekEnd };
    }

    function renderKPIStrip(k) {
      document.getElementById("kpiTotal").textContent = k.total;
      document.getElementById("kpiSent").textContent = k.sentTotal;

      document.getElementById("kpiAddedToday").textContent = k.addedToday;
      document.getElementById("kpiAddedWeek").textContent = k.addedWeek;

      document.getElementById("kpiSentToday").textContent = k.sentToday;
      document.getElementById("kpiSentWeek").textContent = k.sentWeek;

      const tag = document.getElementById("kpiProgressTag");
      tag.innerHTML = `<span class="dot green"></span><span>${k.sentTotal} of ${k.total} completed</span>`;

      document.getElementById("weekRangeLabel").textContent =
        `Week: ${formatDateShort(k.weekStart)} to ${formatDateShort(k.weekEnd)}`;

      const targetRaw = localStorage.getItem(TARGET_KEY);
      const target = targetRaw ? Number(targetRaw) : 0;
      const t = Number.isFinite(target) && target > 0 ? target : 0;

      const pct = t === 0 ? 0 : Math.min(100, Math.round((k.sentWeek / t) * 100));
      document.getElementById("weekProgressBar").style.width = pct + "%";

      const progText = document.getElementById("weekProgressText");
      if (t === 0) {
        progText.textContent = `${k.sentWeek} sent this week. Set a target to track pace`;
      } else {
        const remaining = Math.max(0, t - k.sentWeek);
        progText.textContent = `${k.sentWeek} of ${t} sent this week. ${remaining} remaining`;
      }
    }

    function applyViewFilters(list) {
      const q = safeLower(document.getElementById("search").value);
      const filter = document.getElementById("filterSent").value;

      let out = list.slice();

      if (q) {
        out = out.filter(c => {
          const hay = [c.firstName, c.lastName, c.company, c.email, c.title, c.industry]
            .map(safeLower).join(" ");
          return hay.includes(q);
        });
      }

      if (filter === "sent") out = out.filter(c => c.sent);
      if (filter === "notSent") out = out.filter(c => !c.sent);

      const sortBy = document.getElementById("sortBy").value;

      out.sort((a,b) => {
        const da = parseIso(a.createdAt) || new Date(0);
        const db = parseIso(b.createdAt) || new Date(0);
        const sa = parseIso(a.sentDate) || new Date(0);
        const sb = parseIso(b.sentDate) || new Date(0);

        if (sortBy === "newest") return db - da;
        if (sortBy === "oldest") return da - db;
        if (sortBy === "companyAZ") return safeLower(a.company).localeCompare(safeLower(b.company));
        if (sortBy === "companyZA") return safeLower(b.company).localeCompare(safeLower(a.company));
        if (sortBy === "sentNewest") return sb - sa;
        if (sortBy === "sentOldest") return sa - sb;
        return db - da;
      });

      return out;
    }

    function renderTable() {
      const tbody = document.getElementById("contactsBody");
      tbody.innerHTML = "";

      const view = applyViewFilters(contacts);

      view.forEach(c => {
        const tr = document.createElement("tr");

        const makeCell = (text, isLink) => {
          const td = document.createElement("td");
          if (isLink && text && text.startsWith("http")) {
            const a = document.createElement("a");
            a.href = text;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = "Profile";
            td.appendChild(a);
          } else {
            td.textContent = text || "";
          }
          return td;
        };

        tr.appendChild(makeCell(c.firstName));
        tr.appendChild(makeCell(c.lastName));
        tr.appendChild(makeCell(c.title));
        tr.appendChild(makeCell(c.company));
        tr.appendChild(makeCell(c.email));
        tr.appendChild(makeCell(c.phone));
        tr.appendChild(makeCell(c.industry));
        tr.appendChild(makeCell(c.linkedin, true));

        const stageTd = document.createElement("td");
        const stagePill = document.createElement("span");
        stagePill.className = "pill-stage";
        stagePill.textContent = c.stage || "New";
        stageTd.appendChild(stagePill);
        tr.appendChild(stageTd);

        const statusTd = document.createElement("td");
        const sp = document.createElement("span");
        sp.className = c.sent ? "pill-sent" : "pill-not";
        sp.textContent = c.sent ? "Sent" : "Not sent";
        statusTd.appendChild(sp);
        tr.appendChild(statusTd);

        tr.appendChild(makeCell(c.nextStep));

        const notesTd = document.createElement("td");
        notesTd.className = "mini-note";
        notesTd.textContent = c.notes || "";
        tr.appendChild(notesTd);

        const actionsTd = document.createElement("td");
        actionsTd.style.whiteSpace = "normal";

        const actions = document.createElement("div");
        actions.className = "row-actions";

        const b1 = document.createElement("button");
        b1.className = "btn-small btn-ghost";
        b1.textContent = c.sent ? "Mark not sent" : "Mark sent";
        b1.addEventListener("click", () => toggleSent(c.id));
        actions.appendChild(b1);

        const b2 = document.createElement("button");
        b2.className = "btn-small btn-ghost";
        b2.textContent = "Edit";
        b2.addEventListener("click", () => loadForEdit(c.id));
        actions.appendChild(b2);

        const b3 = document.createElement("button");
        b3.className = "btn-small btn-ghost";
        b3.textContent = "Copy email";
        b3.addEventListener("click", () => copyToClipboard(c.email || ""));
        actions.appendChild(b3);

        const b4 = document.createElement("button");
        b4.className = "btn-small btn-ghost";
        b4.textContent = "Open LinkedIn";
        b4.addEventListener("click", () => {
          if (c.linkedin && c.linkedin.startsWith("http")) window.open(c.linkedin, "_blank", "noopener");
        });
        actions.appendChild(b4);

        const b5 = document.createElement("button");
        b5.className = "btn-small btn-danger";
        b5.textContent = "Delete";
        b5.addEventListener("click", () => deleteContact(c.id));
        actions.appendChild(b5);

        actionsTd.appendChild(actions);
        tr.appendChild(actionsTd);

        tbody.appendChild(tr);
      });
    }

    async function copyToClipboard(text) {
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
      } catch (e) {
        const t = document.createElement("textarea");
        t.value = text;
        document.body.appendChild(t);
        t.select();
        document.execCommand("copy");
        document.body.removeChild(t);
      }
    }

    // Upsert logic:
    function upsertByDedupe(contact) {
      const emailKey = safeLower(contact.email);
      const keyName = safeLower(contact.firstName) + "|" + safeLower(contact.lastName) + "|" + safeLower(contact.company);

      let idx = -1;

      if (emailKey) {
        idx = contacts.findIndex(c => safeLower(c.email) === emailKey);
      } else if (safeLower(contact.firstName) && safeLower(contact.company)) {
        idx = contacts.findIndex(c => {
          const k = safeLower(c.firstName) + "|" + safeLower(c.lastName) + "|" + safeLower(c.company);
          return k === keyName;
        });
      }

      if (idx >= 0) {
        const existing = contacts[idx];
        const incomingHasSent = (typeof contact.sent === "boolean");

        const nextSent = incomingHasSent ? contact.sent : existing.sent;
        const nextSentDate =
          incomingHasSent
            ? (contact.sent ? (contact.sentDate || existing.sentDate || nowIso()) : null)
            : existing.sentDate;

        contacts[idx] = Object.assign({}, existing, contact, {
          id: existing.id,
          createdAt: existing.createdAt || contact.createdAt,
          sent: nextSent,
          sentDate: nextSentDate,
          updatedAt: nowIso()
        });

        return { mode: "updated", contact: contacts[idx] };
      }

      const created = Object.assign({}, normalizeContact(contact), { id: uid(), updatedAt: nowIso() });
      contacts.push(created);
      return { mode: "added", contact: created };
    }

    function getFormContact() {
      return {
        firstName: document.getElementById("firstName").value.trim(),
        lastName: document.getElementById("lastName").value.trim(),
        title: document.getElementById("title").value.trim(),
        company: document.getElementById("company").value.trim(),
        email: document.getElementById("email").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        industry: document.getElementById("industry").value.trim(),
        linkedin: document.getElementById("linkedin").value.trim(),
        stage: document.getElementById("stage").value,
        nextStep: document.getElementById("nextStep").value.trim(),
        notes: document.getElementById("notes").value.trim(),
      };
    }

    async function addOrUpdateFromForm(e) {
      e.preventDefault();

      const base = getFormContact();

      if (!base.firstName) {
        alert("First name is required");
        return;
      }

      // If editing: preserve createdAt + sent state
      if (editId) {
        const idx = contacts.findIndex(c => c.id === editId);
        if (idx >= 0) {
          const existing = contacts[idx];
          contacts[idx] = Object.assign({}, existing, base, {
            id: existing.id,
            createdAt: existing.createdAt,
            sent: existing.sent,
            sentDate: existing.sentDate,
            updatedAt: nowIso()
          });
          const saved = contacts[idx];
          editId = null;
          document.getElementById("submitBtn").textContent = "Add contact to list";
          saveToStorage();
          e.target.reset();
          document.getElementById("importStatus").textContent = "Saved changes";

          // Sheets upsert
          try{ await sheetsUpsert(saved); }catch(err){ setSyncStatus("Sheets sync failed on save"); }
          return;
        }
        editId = null;
      }

      const contact = Object.assign({}, base, { createdAt: nowIso() });

      const result = upsertByDedupe(contact);
      saveToStorage();

      document.getElementById("importStatus").textContent =
        result.mode === "updated" ? "Updated existing record (dedupe match)" : "Added contact";

      // Sheets upsert
      try{ await sheetsUpsert(result.contact); }catch(err){ setSyncStatus("Sheets sync failed on add"); }

      e.target.reset();
    }

    function loadForEdit(id) {
      const c = contacts.find(x => x.id === id);
      if (!c) return;

      editId = id;

      document.getElementById("firstName").value = c.firstName || "";
      document.getElementById("lastName").value = c.lastName || "";
      document.getElementById("title").value = c.title || "";
      document.getElementById("company").value = c.company || "";
      document.getElementById("email").value = c.email || "";
      document.getElementById("phone").value = c.phone || "";
      document.getElementById("industry").value = c.industry || "";
      document.getElementById("linkedin").value = c.linkedin || "";
      document.getElementById("stage").value = c.stage || "New";
      document.getElementById("nextStep").value = c.nextStep || "";
      document.getElementById("notes").value = c.notes || "";

      document.getElementById("submitBtn").textContent = "Save changes";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function toggleSent(id) {
      const idx = contacts.findIndex(c => c.id === id);
      if (idx < 0) return;

      const c = contacts[idx];
      const next = !c.sent;

      c.sent = next;
      c.sentDate = next ? nowIso() : null;
      c.updatedAt = nowIso();

      if (next && (c.stage === "New" || c.stage === "Researched")) c.stage = "Contacted";
      if (!next && c.stage === "Contacted") c.stage = "Researched";

      saveToStorage();

      try{ await sheetsUpsert(c); }catch(err){ setSyncStatus("Sheets sync failed on sent toggle"); }
    }

    async function deleteContact(id) {
      const c = contacts.find(x => x.id === id);
      if (!c) return;
      if (!confirm(`Delete ${c.firstName || ""} ${c.lastName || ""} at ${c.company || ""}?`)) return;

      contacts = contacts.filter(x => x.id !== id);
      saveToStorage();

      try{ await sheetsDelete(c); }catch(err){ setSyncStatus("Sheets delete sync failed"); }
    }

    async function clearAllContacts() {
      if (!confirm("Clear all contacts from this page storage?")) return;
      contacts = [];
      localStorage.removeItem(STORAGE_KEY);
      broadcastUpdate();
      renderAll();
      document.getElementById("importStatus").textContent = "Cleared all contacts";

      try{ await sheetsClearAll(); }catch(err){ setSyncStatus("Sheets clear sync failed"); }
    }

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];

        if (ch === '"' && inQuotes && next === '"') {
          cur += '"';
          i++;
          continue;
        }

        if (ch === '"') {
          inQuotes = !inQuotes;
          continue;
        }

        if (ch === "," && !inQuotes) {
          row.push(cur);
          cur = "";
          continue;
        }

        if ((ch === "\n" || ch === "\r") && !inQuotes) {
          if (ch === "\r" && next === "\n") i++;
          row.push(cur);
          cur = "";
          if (row.some(cell => String(cell).trim() !== "")) rows.push(row);
          row = [];
          continue;
        }

        cur += ch;
      }

      row.push(cur);
      if (row.some(cell => String(cell).trim() !== "")) rows.push(row);
      return rows;
    }

    function handleCsvImport() {
      const input = document.getElementById("csvFile");
      const status = document.getElementById("importStatus");

      if (!input.files || !input.files[0]) {
        alert("Choose a CSV file first");
        return;
      }

      const file = input.files[0];
      const reader = new FileReader();

      reader.onload = e => {
        const text = e.target.result;
        const rows = parseCSV(String(text || ""));

        if (rows.length < 2) {
          status.textContent = "CSV looks empty or missing rows";
          return;
        }

        const header = rows[0].map(h => safeLower(String(h)));
        const col = (name) => header.indexOf(safeLower(name));

        const idxFirst = col("first name");
        const idxLast = col("last name");
        const idxTitle = col("title");
        const idxCompany = col("company name");
        const idxEmail = col("email");
        const idxPhone = col("phone");
        const idxIndustry = col("industry");
        const idxLinkedin = col("person linkedin url");

        const idxStage = col("stage");
        const idxNotes = col("notes");
        const idxNext = col("next step");
        const idxCreated = col("created at");
        const idxSent = col("sent");
        const idxSentDate = col("sent date");

        let added = 0;
        let updated = 0;

        for (let r = 1; r < rows.length; r++) {
          const row = rows[r];

          const contact = normalizeContact({
            firstName: idxFirst >= 0 ? String(row[idxFirst] || "").trim() : "",
            lastName: idxLast >= 0 ? String(row[idxLast] || "").trim() : "",
            title: idxTitle >= 0 ? String(row[idxTitle] || "").trim() : "",
            company: idxCompany >= 0 ? String(row[idxCompany] || "").trim() : "",
            email: idxEmail >= 0 ? String(row[idxEmail] || "").trim() : "",
            phone: idxPhone >= 0 ? String(row[idxPhone] || "").trim() : "",
            industry: idxIndustry >= 0 ? String(row[idxIndustry] || "").trim() : "",
            linkedin: idxLinkedin >= 0 ? String(row[idxLinkedin] || "").trim() : "",
            stage: idxStage >= 0 ? String(row[idxStage] || "").trim() : "New",
            notes: idxNotes >= 0 ? String(row[idxNotes] || "").trim() : "",
            nextStep: idxNext >= 0 ? String(row[idxNext] || "").trim() : "",
            createdAt: idxCreated >= 0 ? String(row[idxCreated] || "").trim() : nowIso(),
            sent: idxSent >= 0 ? safeLower(String(row[idxSent] || "")) === "yes" : false,
            sentDate: idxSentDate >= 0 ? String(row[idxSentDate] || "").trim() : null
          });

          if (!contact.firstName && !contact.email && !contact.company) continue;

          const res = upsertByDedupe(contact);
          if (res.mode === "updated") updated++;
          else added++;
        }

        saveToStorage();
        status.textContent = `Imported ${file.name}\nAdded: ${added}\nUpdated (dedupe): ${updated}`;
      };

      reader.onerror = () => alert("Could not read file");
      reader.readAsText(file);
    }

    function csvQuote(val) {
      const s = String(val ?? "");
      const needs = s.includes(",") || s.includes('"') || s.includes("\n") || s.includes("\r");
      if (!needs) return s;
      return '"' + s.replace(/"/g, '""') + '"';
    }

    function getExportList(mode) {
      const today = new Date();
      const wStart = startOfWeek(today);
      const wEnd = endOfWeek(today);

      if (mode === "sent") return contacts.filter(c => c.sent);
      if (mode === "notSent") return contacts.filter(c => !c.sent);
      if (mode === "thisWeek") {
        return contacts.filter(c => {
          const d = parseIso(c.createdAt);
          return d ? inRange(d, wStart, wEnd) : false;
        });
      }
      return contacts.slice();
    }

    function exportCsv() {
      const mode = document.getElementById("exportMode").value;
      const list = getExportList(mode);

      if (!list.length) {
        alert("No contacts to export in this mode");
        return;
      }

      const headers = [
        "First Name","Last Name","Title","Company Name","Email","Phone","Industry","Person Linkedin Url",
        "Stage","Next Step","Notes","Created At","Updated At","Sent","Sent Date"
      ];

      const lines = [];
      lines.push(headers.join(","));

      list.forEach(c => {
        const row = [
          c.firstName || "",
          c.lastName || "",
          c.title || "",
          c.company || "",
          c.email || "",
          c.phone || "",
          c.industry || "",
          c.linkedin || "",
          c.stage || "",
          c.nextStep || "",
          c.notes || "",
          c.createdAt || "",
          c.updatedAt || "",
          c.sent ? "Yes" : "No",
          c.sentDate || ""
        ].map(csvQuote).join(",");
        lines.push(row);
      });

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `natoli_outbound_contacts_${mode}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadJsonBackup() {
      const payload = { exportedAt: nowIso(), version: 2, contacts };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "natoli_outbound_contacts_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function restoreJson() {
      const input = document.getElementById("jsonFile");
      const status = document.getElementById("importStatus");

      if (!input.files || !input.files[0]) {
        alert("Choose a JSON file first");
        return;
      }

      const file = input.files[0];
      const reader = new FileReader();

      reader.onload = e => {
        try {
          const payload = JSON.parse(String(e.target.result || "{}"));
          const list = Array.isArray(payload.contacts) ? payload.contacts : (Array.isArray(payload) ? payload : null);
          if (!list) {
            status.textContent = "JSON format not recognized";
            return;
          }

          const normalized = list.map(c => normalizeContact(c));

          let added = 0, updated = 0;
          normalized.forEach(c => {
            const res = upsertByDedupe(c);
            if (res.mode === "updated") updated++;
            else added++;
          });

          saveToStorage();
          status.textContent = `Restored from ${file.name}\nAdded: ${added}\nUpdated (dedupe): ${updated}`;
        } catch (err) {
          status.textContent = "Could not parse JSON file";
        }
      };

      reader.onerror = () => alert("Could not read file");
      reader.readAsText(file);
    }

    function toggleListVisibility() {
      document.getElementById("listSection").classList.toggle("hidden");
    }

    function renderWeeklyChart() {
      const canvas = document.getElementById("weeklyChart");
      const ctx = canvas.getContext("2d");

      const cssWidth = canvas.clientWidth;
      const cssHeight = canvas.clientHeight;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(cssWidth * dpr);
      canvas.height = Math.floor(cssHeight * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      const w = cssWidth;
      const h = cssHeight;

      ctx.clearRect(0,0,w,h);

      const today = new Date();
      const thisWeekStart = startOfWeek(today);

      const weeks = [];
      for (let i = 7; i >= 0; i--) {
        const s = new Date(thisWeekStart);
        s.setDate(s.getDate() - (i * 7));
        const e = new Date(s);
        e.setDate(e.getDate() + 6);
        e.setHours(23,59,59,999);
        weeks.push({ start: s, end: e, added: 0, sent: 0 });
      }

      contacts.forEach(c => {
        const created = parseIso(c.createdAt);
        const sent = parseIso(c.sentDate);

        weeks.forEach(wk => {
          if (created && inRange(created, wk.start, wk.end)) wk.added++;
          if (sent && inRange(sent, wk.start, wk.end)) wk.sent++;
        });
      });

      const maxVal = Math.max(1, ...weeks.map(x => Math.max(x.added, x.sent)));

      const padL = 36;
      const padR = 12;
      const padT = 12;
      const padB = 28;

      ctx.strokeStyle = "rgba(34,38,56,.75)";
      ctx.lineWidth = 1;

      const gridY = 4;
      for (let i = 0; i <= gridY; i++) {
        const y = padT + (i / gridY) * (h - padT - padB);
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(w - padR, y);
        ctx.stroke();
      }

      const plotW = (w - padL - padR);
      const plotH = (h - padT - padB);
      const groupW = plotW / weeks.length;
      const barW = Math.max(10, groupW * 0.28);
      const gap = groupW * 0.10;

      function yFor(val) {
        const pct = val / maxVal;
        return padT + (1 - pct) * plotH;
      }

      const red = "rgba(255,59,106,.95)";
      const green = "rgba(34,197,94,.9)";
      const text = "rgba(177,182,200,.95)";

      ctx.font = "12px system-ui, -apple-system, Segoe UI, sans-serif";
      ctx.fillStyle = text;

      weeks.forEach((wk, i) => {
        const x0 = padL + i * groupW;

        const xAdded = x0 + gap;
        const xSent = xAdded + barW + gap;

        const yA = yFor(wk.added);
        ctx.fillStyle = red;
        ctx.fillRect(xAdded, yA, barW, padT + plotH - yA);

        const yS = yFor(wk.sent);
        ctx.fillStyle = green;
        ctx.fillRect(xSent, yS, barW, padT + plotH - yS);

        ctx.fillStyle = text;
        const label = wk.start.toLocaleDateString(undefined, { month:"short", day:"2-digit" });
        ctx.fillText(label, x0 + 2, h - 10);
      });

      ctx.fillStyle = text;
      ctx.fillText(String(maxVal), 6, padT + 10);
      ctx.fillText("0", 12, h - padB + 10);
    }

    function renderCompanyRollup() {
      const tbody = document.getElementById("companyBody");
      tbody.innerHTML = "";

      const q = safeLower(document.getElementById("companySearch").value);
      const limit = Number(document.getElementById("rollupLimit").value || 15);

      const map = new Map();

      contacts.forEach(c => {
        const name = (c.company || "").trim() || "(No company)";
        const key = safeLower(name);
        if (q && !key.includes(q)) return;

        if (!map.has(key)) {
          map.set(key, {
            company: name,
            contacts: 0,
            sent: 0,
            notSent: 0,
            lastActivity: null,
            nextCue: ""
          });
        }
        const agg = map.get(key);
        agg.contacts++;
        if (c.sent) agg.sent++;
        else agg.notSent++;

        const dates = [parseIso(c.updatedAt), parseIso(c.sentDate), parseIso(c.createdAt)].filter(Boolean);
        const best = dates.length ? new Date(Math.max(...dates.map(d => d.getTime()))) : null;
        if (best && (!agg.lastActivity || best > agg.lastActivity)) agg.lastActivity = best;

        const cue = (c.nextStep || "").trim();
        if (cue) {
          const cueDate = parseIso(c.updatedAt) || parseIso(c.createdAt) || new Date(0);
          const aggCueDate = agg._cueDate || new Date(0);
          if (cueDate > aggCueDate) {
            agg.nextCue = cue;
            agg._cueDate = cueDate;
          }
        }
      });

      let rows = Array.from(map.values());

      rows.sort((a,b) => {
        if (b.contacts !== a.contacts) return b.contacts - a.contacts;
        const da = a.lastActivity ? a.lastActivity.getTime() : 0;
        const db = b.lastActivity ? b.lastActivity.getTime() : 0;
        return db - da;
      });

      rows = rows.slice(0, limit);

      const atRiskCount = rows.filter(r => r.contacts >= 3 && r.sent === 0).length;
      document.getElementById("riskBadge").textContent = `${atRiskCount} at risk`;

      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.className = "click-row";
        tr.title = "Click to filter list by this company";
        tr.addEventListener("click", () => {
          document.getElementById("search").value = r.company === "(No company)" ? "" : r.company;
          document.getElementById("filterSent").value = "all";
          document.getElementById("sortBy").value = "newest";
          const listSection = document.getElementById("listSection");
          if (listSection.classList.contains("hidden")) listSection.classList.remove("hidden");
          renderTable();
        });

        const rate = r.contacts === 0 ? 0 : Math.round((r.sent / r.contacts) * 100);
        const last = r.lastActivity ? r.lastActivity.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" }) : "";

        const flagTd = document.createElement("td");
        if (r.contacts >= 3 && r.sent === 0) {
          const risk = document.createElement("span");
          risk.className = "pill-risk";
          risk.textContent = "At risk";
          flagTd.appendChild(risk);
        } else {
          flagTd.textContent = "";
        }

        tr.innerHTML = `
          <td>${escapeHtml(r.company)}</td>
          <td>${r.contacts}</td>
          <td>${r.sent}</td>
          <td>${r.notSent}</td>
          <td>${rate}%</td>
          <td>${last}</td>
          <td class="mini-note">${escapeHtml(r.nextCue || "")}</td>
        `;
        tr.appendChild(flagTd);
        tbody.appendChild(tr);
      });
    }

    function renderAll() {
      const k = computeKPIs();
      renderKPIStrip(k);
      renderWeeklyChart();
      renderCompanyRollup();
      renderTable();
    }

    // =============================
    // EVENTS
    // =============================
    document.getElementById("contactForm").addEventListener("submit", addOrUpdateFromForm);
    document.getElementById("clearAll").addEventListener("click", clearAllContacts);

    document.getElementById("importCsv").addEventListener("click", handleCsvImport);
    document.getElementById("exportCsv").addEventListener("click", exportCsv);

    document.getElementById("backupJson").addEventListener("click", downloadJsonBackup);
    document.getElementById("restoreJson").addEventListener("click", restoreJson);

    document.getElementById("toggleList").addEventListener("click", toggleListVisibility);

    document.getElementById("saveTarget").addEventListener("click", saveTarget);

    ["search","filterSent","sortBy"].forEach(id => {
      document.getElementById(id).addEventListener("input", renderTable);
      document.getElementById(id).addEventListener("change", renderTable);
    });

    ["companySearch","rollupLimit"].forEach(id => {
      document.getElementById(id).addEventListener("input", renderCompanyRollup);
      document.getElementById(id).addEventListener("change", renderCompanyRollup);
    });

    window.addEventListener("resize", () => renderWeeklyChart());

    window.addEventListener("storage", (e) => {
      if (e.key === STORAGE_KEY || e.key === "NATOLI_OUTBOUND_LAST_UPDATE") loadFromStorage();
    });
    if (BC) {
      BC.onmessage = (msg) => {
        if (msg && msg.data && msg.data.type === "contacts_updated") loadFromStorage();
      };
    }

    // =============================
    // START
    // =============================
    loadFromStorage();
  </script>
</body>
</html>
