<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Natoli Dashboard – Tony Beal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      /* Natoli style: red / black / white */
      --bg: #060607;
      --bg-deep: #020203;
      --panel: #0b0b0d;
      --panel-2: #0f0f12;

      --red: #e11d2e;
      --red-2: #b3121f;
      --red-soft: rgba(225, 29, 46, 0.18);

      --white: #ffffff;
      --text: #f8fafc;
      --muted: rgba(248, 250, 252, 0.72);
      --muted-2: rgba(248, 250, 252, 0.55);

      --border: rgba(255, 255, 255, 0.10);
      --border-2: rgba(255, 255, 255, 0.14);

      --radius-pill: 999px;
      --radius-lg: 18px;

      --shadow: 0 18px 45px rgba(0, 0, 0, 0.75);
      --shadow-red: 0 18px 55px rgba(225, 29, 46, 0.22);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 32px 16px 48px;
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;

      background:
        radial-gradient(900px 520px at 12% -8%, rgba(225, 29, 46, 0.22) 0%, rgba(2, 2, 3, 0) 60%),
        radial-gradient(800px 520px at 88% -10%, rgba(225, 29, 46, 0.16) 0%, rgba(2, 2, 3, 0) 60%),
        radial-gradient(900px 600px at 50% 10%, rgba(255, 255, 255, 0.06) 0%, rgba(2, 2, 3, 0) 55%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg-deep) 70%);
    }

    .shell {
      max-width: 1180px;
      margin: 0 auto;
    }

    /* HEADER */

    .eyebrow {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 6px;
    }

    h1 {
      font-size: 40px;
      margin: 0 0 6px;
      letter-spacing: 0.01em;
    }

    .subtitle-main {
      font-size: 16px;
      color: var(--muted);
    }

    .subtitle-note {
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted-2);
      max-width: 980px;
      line-height: 1.45;
    }

    /* KPI STRIP */

    .kpi-grid {
      margin-top: 26px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
    }

    .kpi-card {
      background:
        radial-gradient(900px 420px at 10% 0%, rgba(225, 29, 46, 0.10) 0%, rgba(11, 11, 13, 0) 55%),
        linear-gradient(180deg, var(--panel) 0%, rgba(6,6,7,0.7) 100%);
      border-radius: 24px;
      padding: 18px 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .kpi-label {
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted-2);
      margin-bottom: 10px;
    }

    .kpi-main {
      font-size: 28px;
      font-weight: 650;
      margin-bottom: 8px;
    }

    .kpi-bar-shell {
      margin-top: 2px;
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .kpi-bar-fill {
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, var(--red), rgba(225, 29, 46, 0.55));
    }

    .kpi-pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .kpi-pill {
      padding: 7px 11px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255,255,255,0.14);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: rgba(255,255,255,0.88);
      background: rgba(255,255,255,0.04);
      backdrop-filter: blur(6px);
    }

    .kpi-pill.red {
      border-color: rgba(225, 29, 46, 0.75);
      background: radial-gradient(circle at top, rgba(225, 29, 46, 0.25) 0, rgba(255,255,255,0.04) 65%);
      box-shadow: var(--shadow-red);
    }

    .kpi-text {
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }

    /* MAIN TABS */

    .tabs-main {
      margin-top: 26px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .tab-pill {
      padding: 10px 20px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.78);
      font-size: 13px;
      cursor: pointer;
      transition: transform 0.06s ease, box-shadow 0.18s ease, background 0.18s ease, color 0.18s ease, border-color 0.18s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .tab-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 45px rgba(0,0,0,0.65);
      color: var(--white);
      border-color: rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.05);
    }

    .tab-pill.active {
      background:
        radial-gradient(900px 340px at 20% 0%, rgba(225, 29, 46, 0.30) 0%, rgba(225, 29, 46, 0.10) 40%, rgba(255,255,255,0.03) 100%);
      border-color: rgba(225, 29, 46, 0.75);
      color: #fff;
      box-shadow: var(--shadow-red);
    }

    /* LINK BUTTONS */

    .link-row {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }

    .link-button {
      padding: 10px 20px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.92);
      color: #0b0b0d;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      box-shadow: 0 18px 45px rgba(0,0,0,0.55);
      transition: transform 0.06s ease, box-shadow 0.18s ease, background 0.18s ease;
    }

    .link-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 20px 55px rgba(0,0,0,0.7);
      background: #fff;
    }

    /* TAB CONTENT */

    .tab {
      display: none;
      margin-top: 28px;
    }

    .tab.active {
      display: block;
    }

    h2.section-title {
      font-size: 22px;
      margin-bottom: 6px;
      letter-spacing: 0.01em;
    }

    p.section-intro {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 18px;
      max-width: 900px;
      line-height: 1.45;
    }

    /* METRIC CARDS */

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
    }

    .metric-card {
      background:
        radial-gradient(900px 420px at 10% 0%, rgba(225, 29, 46, 0.12) 0%, rgba(11, 11, 13, 0) 55%),
        linear-gradient(180deg, var(--panel-2) 0%, rgba(6,6,7,0.7) 100%);
      border-radius: var(--radius-lg);
      padding: 16px 16px 14px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .metric-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted-2);
      margin-bottom: 6px;
    }

    .metric-main {
      font-size: 26px;
      font-weight: 650;
      margin-bottom: 2px;
    }

    .metric-week {
      font-size: 12px;
      color: rgba(225, 29, 46, 0.95);
      margin-bottom: 6px;
      font-weight: 600;
    }

    .metric-sub {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .csv-input {
      margin-bottom: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    .csv-input label {
      font-weight: 600;
      color: rgba(255,255,255,0.86);
    }

    .csv-input input[type="file"] {
      margin-top: 4px;
      font-size: 11px;
      color: rgba(255,255,255,0.85);
    }

    .chart-wrap {
      margin-top: 6px;
      min-height: 160px;
    }

    /* EMAIL CAMPAIGN PERFORMANCE */

    .email-section {
      margin-top: 40px;
      padding-top: 6px;
      border-top: 1px solid rgba(255,255,255,0.10);
    }

    .email-upload-card {
      background:
        radial-gradient(900px 420px at 10% 0%, rgba(225, 29, 46, 0.12) 0%, rgba(11, 11, 13, 0) 55%),
        linear-gradient(180deg, var(--panel-2) 0%, rgba(6,6,7,0.7) 100%);
      border-radius: var(--radius-lg);
      padding: 14px 16px 14px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      margin-bottom: 18px;
    }

    .email-upload-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .email-upload-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted-2);
    }

    .email-upload-note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      max-width: 680px;
      line-height: 1.45;
    }

    .email-upload-input input[type="file"] {
      font-size: 11px;
      color: rgba(255,255,255,0.85);
    }

    .email-chart-wrap {
      margin-top: 12px;
      min-height: 220px;
    }

    .email-table-wrap {
      margin-top: 18px;
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    table.email-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      color: rgba(255,255,255,0.88);
    }

    table.email-table thead {
      background: rgba(0,0,0,0.35);
    }

    table.email-table th,
    table.email-table td {
      padding: 9px 11px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align: left;
      vertical-align: top;
    }

    table.email-table th {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 11px;
      color: rgba(255,255,255,0.60);
      white-space: nowrap;
    }

    table.email-table tbody tr:nth-child(even) {
      background: rgba(255,255,255,0.03);
    }

    table.email-table tbody tr:last-child td {
      border-bottom: none;
    }

    .footnote {
      font-size: 11px;
      color: rgba(255,255,255,0.58);
      padding: 10px 12px 12px;
      background: rgba(0,0,0,0.28);
    }

    @media (max-width: 720px) {
      body { padding: 20px 10px 32px; }
      h1 { font-size: 30px; }
      .tabs-main { gap: 6px; }
      .tab-pill { font-size: 12px; padding: 8px 14px; }
      .link-button { width: 100%; text-align: center; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <!-- HEADER -->
    <div class="eyebrow">NATOLI ENGINEERING HEADQUARTERS</div>
    <h1>Natoli Dashboard</h1>
    <div class="subtitle-main">
      Sales Navigator Coach Elite | Lead Generation and RevOps View
    </div>
    <div class="subtitle-note">
      You are now fully on horizontal bar KPI charts across the front page. All numbers roll up from CSV files on the detailed tabs.
    </div>

    <!-- KPI STRIP -->
    <div class="kpi-grid">
      <!-- SALES NAV COACH -->
      <div class="kpi-card">
        <div class="kpi-label">Sales Navigator coach level</div>
        <div class="kpi-main">Expert</div>
        <div class="kpi-bar-shell">
          <div class="kpi-bar-fill"></div>
        </div>
        <div class="kpi-text">
          Coach status reflects consistent use of advanced features like account mapping, persona-based lists and saved lead workflows.
        </div>
      </div>

      <!-- SSI -->
      <div class="kpi-card">
        <div class="kpi-label">Social selling index</div>
        <div class="kpi-main">77 / 100</div>
        <div class="kpi-bar-shell">
          <div class="kpi-bar-fill" style="width: 77%;"></div>
        </div>

        <div class="kpi-pill-row">
          <div class="kpi-pill red">Top 1 percent industry</div>
          <div class="kpi-pill red">Top 1 percent network</div>
          <div class="kpi-pill">Team rank 1 of 1</div>
        </div>

        <div class="kpi-text">
          This is the same SSI view you see inside Sales Navigator, pulled into your own executive style dashboard.
        </div>
      </div>

      <!-- SUMMARY -->
      <div class="kpi-card">
        <div class="kpi-label">Dashboard summary</div>
        <div class="kpi-text">
          This overview pulls four levers: LinkedIn connections, outbound contact volume, opportunities and wins and email campaign performance.
          Upload fresh CSV files on the detailed tabs and this front page will update in a few seconds.
        </div>
        <div class="kpi-pill-row" style="margin-top: 14px;">
          <div class="kpi-pill">CSV driven</div>
          <div class="kpi-pill red">Fortune 50 layout</div>
          <div class="kpi-pill">Executive ready</div>
        </div>
      </div>
    </div>

    <!-- MAIN TABS -->
    <div class="tabs-main">
      <button class="tab-pill active" onclick="showTab('dashboard', this)">Dashboard</button>

      <!-- IMPORTANT: THIS ONE NOW OPENS THE PAGE -->
      <a class="tab-pill" href="outbound-activity.html">Natoli Outbound Activity</a>

      <button class="tab-pill" onclick="showTab('opportunities', this)">Opportunities and Wins</button>
      <button class="tab-pill" onclick="showTab('campaigns', this)">Email Campaigns</button>
      <button class="tab-pill" onclick="showTab('linkedin-tab', this)">LinkedIn and Contacts</button>
      <button class="tab-pill" onclick="showTab('hours', this)">Hours and Value</button>
      <button class="tab-pill" onclick="showTab('ai', this)">Natoli AI Decks</button>
      <button class="tab-pill" onclick="showTab('media', this)">Media Scoreboard</button>
      <button class="tab-pill" onclick="showTab('persona', this)">StoryBrand Persona</button>
      <button class="tab-pill" onclick="showTab('timer', this)">Open Timer</button>
    </div>

    <!-- LINK BUTTONS -->
    <div class="link-row">
      <a class="link-button" href="https://www.linkedin.com/company/natoli-engineering-company-inc-" target="_blank" rel="noopener">
        Natoli Engineering LinkedIn
      </a>
      <a class="link-button" href="https://www.linkedin.com/company/natoli-scientific" target="_blank" rel="noopener">
        Natoli Scientific LinkedIn
      </a>
      <a class="link-button" href="https://www.linkedin.com/in/tony-beal40/" target="_blank" rel="noopener">
        Tony Beal LinkedIn
      </a>
    </div>

    <!-- DASHBOARD TAB -->
    <div id="dashboard" class="tab active">
      <h2 class="section-title">Lead generation overview</h2>
      <p class="section-intro">
        Upload your CSV files and this page will show totals, weekly trends and horizontal KPI charts for the most important
        lead generation metrics on your desk.
      </p>

      <div class="metrics-grid">
        <!-- LINKEDIN CONNECTIONS -->
        <div class="metric-card">
          <div class="metric-title">LinkedIn connections</div>
          <div class="metric-main" id="linkedin-total">0</div>
          <div class="metric-week" id="linkedin-week">This week: 0</div>
          <div class="metric-sub">
            Upload your LinkedIn connections CSV to track total connections and how many were added in the last seven days.
          </div>
          <div class="csv-input">
            <label for="linkedinCsv">Upload LinkedIn CSV</label><br />
            <input type="file" id="linkedinCsv" accept=".csv" />
          </div>
          <div class="chart-wrap">
            <canvas id="linkedinChart"></canvas>
          </div>
        </div>

        <!-- OUTBOUND CONTACTS (AUTO FROM OUTBOUND PAGE STORAGE) -->
        <div class="metric-card">
          <div class="metric-title">Outbound contacts</div>
          <div class="metric-main" id="outbound-total">0</div>
          <div class="metric-week" id="outbound-week">This week: 0</div>
          <div class="metric-sub">
            Auto-pulls from your Outbound Activity page storage. Add contacts there and this tile updates on refresh.
          </div>
          <div class="csv-input">
            <div style="font-size:12px;color:rgba(248,250,252,0.72);line-height:1.45;">
              Source: <span style="color: rgba(225,29,46,0.95); font-weight:700;">localStorage</span> on this browser<br/>
              <a href="outbound-activity.html" style="color: rgba(225,29,46,0.95); font-weight:700; text-decoration:none;">Open Outbound Activity</a>
            </div>
          </div>
          <div class="chart-wrap">
            <canvas id="outboundChart"></canvas>
          </div>
        </div>

        <!-- OPPORTUNITIES & WINS -->
        <div class="metric-card">
          <div class="metric-title">Opportunities and wins</div>
          <div class="metric-main" id="opp-total">0</div>
          <div class="metric-week" id="opp-wins">Wins: 0</div>
          <div class="metric-sub">
            Upload a pipeline CSV and the dashboard will count total opportunities and how many are marked as wins.
          </div>
          <div class="csv-input">
            <label for="oppCsv">Upload Opportunities CSV</label><br />
            <input type="file" id="oppCsv" accept=".csv" />
          </div>
          <div class="chart-wrap">
            <canvas id="oppChart"></canvas>
          </div>
        </div>

        <!-- EMAIL KPI TILE (DRIVEN BY EMAIL CSV BELOW) -->
        <div class="metric-card">
          <div class="metric-title">Email campaigns</div>
          <div class="metric-main" id="email-total">0</div>
          <div class="metric-week" id="email-open-rate">Average open rate: 0%</div>
          <div class="metric-sub">
            Numbers roll up from the Email Campaign Performance CSV below. One row per campaign with recipients and opens.
          </div>
          <div class="chart-wrap">
            <canvas id="emailKpiChart"></canvas>
          </div>
        </div>
      </div>

      <!-- EMAIL CAMPAIGN PERFORMANCE -->
      <div class="email-section">
        <h2 class="section-title">Email campaign performance</h2>
        <p class="section-intro">
          Upload your email campaign summary CSV to populate the chart and table below. This mirrors the internal Natoli
          format so you can see recipients, deliveries, unique opens, open rate, clicks, click rate and notes in one view.
        </p>

        <div class="email-upload-card">
          <div class="email-upload-header">
            <div>
              <div class="email-upload-title">Email campaigns – summary</div>
              <div class="email-upload-note">
                Use one row per campaign with at least <strong>Campaign</strong>, <strong>Recipients</strong>,
                <strong>Deliveries</strong> and <strong>Unique opens</strong>. Additional columns like
                open rate, unique clicks, click rate and notes will be displayed if present.
              </div>
            </div>
            <div class="email-upload-input">
              <label for="emailCsv" style="font-size:12px; font-weight:700; color: rgba(255,255,255,0.9);">
                Upload email campaign summary CSV
              </label><br />
              <input type="file" id="emailCsv" accept=".csv" />
            </div>
          </div>

          <div class="email-chart-wrap">
            <canvas id="emailPerfChart"></canvas>
          </div>
        </div>

        <div class="email-table-wrap">
          <table class="email-table">
            <thead>
              <tr>
                <th>Campaign</th>
                <th>Division focus</th>
                <th>Recipients</th>
                <th>Deliveries</th>
                <th>Unique opens</th>
                <th>Open rate</th>
                <th>Unique clicks</th>
                <th>Click rate</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="emailTableBody"></tbody>
          </table>
          <div class="footnote">
            Unsubscribe rates remained under 1 percent for nearly every campaign. Open and click rates are consistently
            at or above typical benchmarks for industrial B2B audiences.
          </div>
        </div>
      </div>
    </div>

    <!-- OTHER TABS -->
    <div id="opportunities" class="tab"><h2 class="section-title">Opportunities and wins</h2><p class="section-intro">Detailed pipeline and win tracking will live here.</p></div>
    <div id="campaigns" class="tab"><h2 class="section-title">Email campaigns</h2><p class="section-intro">Email-only view can be duplicated here later.</p></div>
    <div id="linkedin-tab" class="tab"><h2 class="section-title">LinkedIn and contacts</h2><p class="section-intro">Follower tracking and contact management will live here.</p></div>
    <div id="hours" class="tab"><h2 class="section-title">Hours and value</h2><p class="section-intro">Time and value reporting will live here.</p></div>
    <div id="ai" class="tab"><h2 class="section-title">Natoli AI decks</h2><p class="section-intro">Deck links will live here.</p></div>
    <div id="media" class="tab"><h2 class="section-title">Media scoreboard</h2><p class="section-intro">Media scorecard navigation will live here.</p></div>
    <div id="persona" class="tab"><h2 class="section-title">StoryBrand persona</h2><p class="section-intro">Persona notes will live here.</p></div>
    <div id="timer" class="tab"><h2 class="section-title">Open timer</h2><p class="section-intro">Timer will live here.</p></div>

  </div>

  <!-- LIBRARIES -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ---------- TAB HANDLING ----------
    function showTab(id, btn) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.tabs-main .tab-pill').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
    }

    // ---------- CSV HELPERS ----------
    function detectDateField(row) {
      if (!row) return null;
      const keys = Object.keys(row);
      for (const k of keys) {
        const lower = k.toLowerCase();
        if (lower.includes('date') || lower.includes('time') || lower.includes('created')) return k;
      }
      return null;
    }

    function toWeekKey(d) {
      const date = new Date(d);
      if (isNaN(date.getTime())) return null;
      const yearStart = new Date(date.getFullYear(), 0, 1);
      const dayOfYear = Math.floor((date - yearStart) / 86400000) + 1;
      const week = Math.ceil(dayOfYear / 7);
      return date.getFullYear() + '-W' + String(week).padStart(2, '0');
    }

    function countWeekly(rows, dateField) {
      const counts = {};
      const now = new Date();
      const sevenDaysAgo = new Date(now.getTime() - 7 * 86400000);
      let lastWeekCount = 0;

      for (const row of rows) {
        if (!dateField || !row[dateField]) continue;
        const date = new Date(row[dateField]);
        if (isNaN(date.getTime())) continue;

        const key = toWeekKey(date);
        if (!key) continue;
        counts[key] = (counts[key] || 0) + 1;
        if (date >= sevenDaysAgo && date <= now) lastWeekCount += 1;
      }

      return { counts, lastWeekCount };
    }

    function handleCsv(inputId, callback) {
      const input = document.getElementById(inputId);
      if (!input) return;
      input.addEventListener('change', function () {
        const file = this.files[0];
        if (!file) return;
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            callback(results.data || []);
          }
        });
      });
    }

    // ---------- CHART THEME: force red/white ----------
    Chart.defaults.color = "rgba(255,255,255,0.80)";
    Chart.defaults.borderColor = "rgba(255,255,255,0.10)";

    const charts = {};

    function buildHorizontalBar(canvasId, labels, data, key) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (charts[key]) charts[key].destroy();
      charts[key] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data,
            borderWidth: 1,
            backgroundColor: "rgba(225,29,46,0.75)",
            borderColor: "rgba(255,255,255,0.18)"
          }]
        },
        options: {
          indexAxis: 'y',
          plugins: { legend: { display: false } },
          scales: {
            x: {
              beginAtZero: true,
              grid: { color: "rgba(255,255,255,0.08)" }
            },
            y: { grid: { display: false } }
          }
        }
      });
    }

    function buildPie(canvasId, labels, data, key) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (charts[key]) charts[key].destroy();
      charts[key] = new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data,
            borderWidth: 1,
            backgroundColor: [
              "rgba(225,29,46,0.85)",
              "rgba(255,255,255,0.18)"
            ],
            borderColor: "rgba(0,0,0,0.0)"
          }]
        },
        options: {
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    // ---------- LINKEDIN CSV ----------
    handleCsv('linkedinCsv', function (rows) {
      const total = rows.length;
      document.getElementById('linkedin-total').textContent = total;

      const dateField = detectDateField(rows[0]);
      const { counts, lastWeekCount } = countWeekly(rows, dateField);
      document.getElementById('linkedin-week').textContent = 'This week: ' + lastWeekCount;

      const labels = Object.keys(counts).sort();
      const data = labels.map(k => counts[k]);
      if (labels.length) buildHorizontalBar('linkedinChart', labels, data, 'linkedin');
    });

    // ---------- OPPORTUNITIES CSV ----------
    handleCsv('oppCsv', function (rows) {
      const total = rows.length;
      document.getElementById('opp-total').textContent = total;

      let statusField = null;
      if (rows[0]) {
        for (const key of Object.keys(rows[0])) {
          const lower = key.toLowerCase();
          if (lower.includes('status') || lower.includes('stage') || lower.includes('result') || lower.includes('outcome') || lower.includes('state')) {
            statusField = key;
            break;
          }
        }
      }

      let wins = 0;
      if (statusField) {
        for (const row of rows) {
          const value = String(row[statusField] || '').toLowerCase();
          if (value.includes('win') || value.includes('closed won')) wins += 1;
        }
      }

      document.getElementById('opp-wins').textContent = 'Wins: ' + wins;

      const other = total - wins;
      buildPie('oppChart', ['Wins', 'Other'], [wins, other], 'opp');
    });

    // ---------- EMAIL CAMPAIGN CSV ----------
    handleCsv('emailCsv', function (rows) {
      const tbody = document.getElementById('emailTableBody');
      tbody.innerHTML = '';
      if (!rows.length) return;

      const keys = Object.keys(rows[0]);

      const findField = (matchFn) => {
        for (const k of keys) if (matchFn(k.toLowerCase())) return k;
        return null;
      };

      const campaignField   = findField(l => l.includes('campaign'));
      const divisionField   = findField(l => l.includes('division'));
      const recipientsField = findField(l => l.includes('recipient') || l.includes('sent'));
      const deliveriesField = findField(l => l.includes('deliver'));
      const opensField      = findField(l => l.includes('unique open') || (l.includes('open') && !l.includes('rate')));
      const openRateField   = findField(l => l.includes('open rate'));
      const clicksField     = findField(l => l.includes('unique click') || (l.includes('click') && !l.includes('rate')));
      const clickRateField  = findField(l => l.includes('click rate'));
      const notesField      = findField(l => l.includes('note'));

      let totalCampaigns = rows.length;
      let totalRecipients = 0;
      let totalOpens = 0;

      const chartLabels = [];
      const chartOpenRates = [];

      rows.forEach(row => {
        const recipients = parseFloat(row[recipientsField] || 0) || 0;
        const opens = parseFloat(row[opensField] || 0) || 0;
        totalRecipients += recipients;
        totalOpens += opens;

        let numericOpenRate = 0;
        if (recipients > 0) numericOpenRate = (opens / recipients) * 100;

        chartLabels.push((campaignField && row[campaignField]) ? row[campaignField] : '');
        chartOpenRates.push(numericOpenRate);

        const tr = document.createElement('tr');
        const td = (value) => {
          const cell = document.createElement('td');
          cell.textContent = value || '';
          return cell;
        };

        tr.appendChild(td(campaignField ? row[campaignField] : ''));
        tr.appendChild(td(divisionField ? row[divisionField] : ''));
        tr.appendChild(td(recipientsField ? row[recipientsField] : ''));
        tr.appendChild(td(deliveriesField ? row[deliveriesField] : ''));
        tr.appendChild(td(opensField ? row[opensField] : ''));

        let openRateDisplay = '';
        if (openRateField && row[openRateField]) openRateDisplay = row[openRateField];
        else if (recipients > 0) openRateDisplay = numericOpenRate.toFixed(1) + '%';
        tr.appendChild(td(openRateDisplay));

        tr.appendChild(td(clicksField ? row[clicksField] : ''));
        tr.appendChild(td(clickRateField ? row[clickRateField] : ''));
        tr.appendChild(td(notesField ? row[notesField] : ''));

        tbody.appendChild(tr);
      });

      document.getElementById('email-total').textContent = totalCampaigns.toString();

      let avgOpenRate = 0;
      if (totalRecipients > 0) avgOpenRate = (totalOpens / totalRecipients) * 100;
      document.getElementById('email-open-rate').textContent = 'Average open rate: ' + avgOpenRate.toFixed(1) + '%';

      const notOpened = Math.max(totalRecipients - totalOpens, 0);
      buildPie('emailKpiChart', ['Opened', 'Not opened'], [totalOpens, notOpened], 'emailKpi');

      buildHorizontalBar('emailPerfChart', chartLabels, chartOpenRates, 'emailPerf');
    });

    // ---------- OUTBOUND STORAGE ROLLUP (AUTO TILE + CHART) ----------
    const OUTBOUND_STORAGE_KEY = "natoliOutboundContactsV2";

    function startOfWeekMonday(d) {
      const x = new Date(d);
      const day = (x.getDay() + 6) % 7; // Monday = 0
      x.setDate(x.getDate() - day);
      x.setHours(0,0,0,0);
      return x;
    }

    function endOfWeekSunday(d) {
      const s = startOfWeekMonday(d);
      const e = new Date(s);
      e.setDate(e.getDate() + 6);
      e.setHours(23,59,59,999);
      return e;
    }

    function parseIsoSafe(iso) {
      const dt = new Date(iso);
      return isNaN(dt.getTime()) ? null : dt;
    }

    function inRange(dt, start, end) {
      const t = dt.getTime();
      return t >= start.getTime() && t <= end.getTime();
    }

    function toWeekKeyMonday(d) {
      const date = new Date(d);
      if (isNaN(date.getTime())) return null;
      const s = startOfWeekMonday(date);
      const y = s.getFullYear();
      const jan1 = new Date(y, 0, 1);
      const days = Math.floor((s - jan1) / 86400000);
      const week = Math.floor(days / 7) + 1;
      return `${y}-W${String(week).padStart(2,'0')}`;
    }

    function loadOutboundFromStorage() {
      try {
        const raw = localStorage.getItem(OUTBOUND_STORAGE_KEY);
        const list = raw ? JSON.parse(raw) : [];
        return Array.isArray(list) ? list : [];
      } catch (e) {
        return [];
      }
    }

    function updateOutboundTileAndChart() {
      const elTotal = document.getElementById("outbound-total");
      const elWeek = document.getElementById("outbound-week");
      if (!elTotal || !elWeek) return;

      const contacts = loadOutboundFromStorage();

      const total = contacts.length;
      const now = new Date();
      const wStart = startOfWeekMonday(now);
      const wEnd = endOfWeekSunday(now);

      const thisWeek = contacts.filter(c => {
        const created = parseIsoSafe(c.createdAt || c["Created At"]);
        return created ? inRange(created, wStart, wEnd) : false;
      }).length;

      elTotal.textContent = total;
      elWeek.textContent = "This week: " + thisWeek;

      // Build weekly chart from storage (last ~10 weeks)
      const counts = {};
      contacts.forEach(c => {
        const created = parseIsoSafe(c.createdAt || c["Created At"]);
        if (!created) return;
        const wk = toWeekKeyMonday(created);
        if (!wk) return;
        counts[wk] = (counts[wk] || 0) + 1;
      });

      const labels = Object.keys(counts).sort();
      const data = labels.map(k => counts[k]);
      if (labels.length) buildHorizontalBar("outboundChart", labels, data, "outboundStorage");
    }

    // run once on load
    updateOutboundTileAndChart();

    // update if data changes in another tab
    window.addEventListener("storage", (e) => {
      if (e.key === OUTBOUND_STORAGE_KEY) updateOutboundTileAndChart();
    });
  </script>
</body>
</html>

<a href="/outbound/" class="pill">Outbound Activity</a>

